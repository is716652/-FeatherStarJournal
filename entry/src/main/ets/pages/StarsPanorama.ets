import router from '@ohos.router';
import { YanqinLogicEngine, AnimalData } from '../utils/YanqinLogicEngine';

/**
 * å››è±¡é¢œè‰²é…ç½®æ¥å£
 */
interface QuadrantColors {
  east: string;
  north: string;
  west: string;
  south: string;
}

/**
 * 28æ˜Ÿå®¿å…¨æ™¯å›¾é¡µé¢
 * ä½¿ç”¨ Canvas ç»˜åˆ¶äº¤äº’å¼æ˜Ÿå®¿è½¨é“å›¾
 */
@Entry
@Component
struct StarsPanorama {
  @State canvasWidth: number = 0;
  @State canvasHeight: number = 0;
  @State selectedStar: string = '';
  @State selectedStarDetail: AnimalData | null = null;
  @State currentUserStar: string = ''; // ç”¨æˆ·çš„ä¸»æ˜Ÿ
  
  private settings: RenderingContextSettings = new RenderingContextSettings(true);
  private renderContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings);
  private logicEngine: YanqinLogicEngine = YanqinLogicEngine.getInstance();
  private stars: string[] = [];
  
  // å››è±¡é…è‰²æ–¹æ¡ˆ
  private readonly colors: QuadrantColors = {
    east: '#00CED1',    // é’é¾™ - é’è‰²
    north: '#000080',   // ç„æ­¦ - æ·±è“
    west: '#FFD700',    // ç™½è™ - é‡‘è‰²
    south: '#FF4500'    // æœ±é›€ - çº¢è‰²
  };

  async aboutToAppear() {
    this.stars = this.logicEngine.getAllStars();
    
    // è·å–ç”¨æˆ·å½“å‰ä¸»æ˜Ÿï¼ˆä»è·¯ç”±å‚æ•°æˆ–æœ¬åœ°å­˜å‚¨ï¼‰
    const params = router.getParams() as Record<string, string>;
    if (params && params['userStar']) {
      this.currentUserStar = params['userStar'];
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image($r('sys.symbol.chevron_left'))
          .width(24)
          .height(24)
          .fillColor('#D4AF37')
          .onClick(() => {
            router.back();
          })
        
        Text('äºŒåå…«å®¿å…¨æ™¯å›¾')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#D4AF37')
          .margin({ left: 12 })
        
        Blank()
        
        Text('ç‚¹å‡»æ˜Ÿå®¿æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(12)
          .fontColor('#888888')
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#1A1A1A')

      // Canvas ç»˜åˆ¶åŒºåŸŸ
      Canvas(this.renderContext)
        .width('100%')
        .height('70%')
        .backgroundColor('#000000')
        .onReady(() => {
          // è·å– Canvas å®é™…å°ºå¯¸
          this.canvasWidth = this.renderContext.width;
          this.canvasHeight = this.renderContext.height;
          console.info(`[StarsPanorama] Canvas size: ${this.canvasWidth} x ${this.canvasHeight}`);
          this.drawStarMap();
        })
        .onTouch((event) => {
          if (event.type === TouchType.Down) {
            this.handleCanvasTouch(event.touches[0].x, event.touches[0].y);
          }
        })

      // åº•éƒ¨è¯¦æƒ…å±•ç¤ºåŒº
      Column() {
        if (this.selectedStarDetail) {
          Column() {
            Text(this.selectedStarDetail.full_name)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#D4AF37')
              .margin({ bottom: 8 })
            
            Row() {
              Text(`æ˜Ÿå®¿ï¼š${this.selectedStarDetail.star}`)
                .fontSize(16)
                .fontColor('#FFFFFF')
                .margin({ right: 20 })
              
              Text(`ä¸ƒæ›œï¼š${this.selectedStarDetail.element}`)
                .fontSize(16)
                .fontColor('#FFFFFF')
                .margin({ right: 20 })
              
              Text(`ç¦½è±¡ï¼š${this.selectedStarDetail.animal}`)
                .fontSize(16)
                .fontColor('#FFFFFF')
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#1A1A1A')
          .borderRadius(12)
        } else {
          Column() {
            Text('ç‚¹å‡»æ˜Ÿå®¿æŸ¥çœ‹è¯¦æƒ…')
              .fontSize(16)
              .fontColor('#888888')
          }
          .width('100%')
          .height(100)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('90%')
      .margin({ top: 20 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }

  /**
   * ç»˜åˆ¶æ˜Ÿå®¿å…¨æ™¯å›¾
   */
  private drawStarMap() {
    if (!this.renderContext || this.canvasWidth === 0 || this.canvasHeight === 0) {
      console.warn('[StarsPanorama] Canvas not ready');
      return;
    }

    const ctx = this.renderContext;
    const centerX = this.canvasWidth / 2;
    const centerY = this.canvasHeight / 2;
    const radius = Math.min(centerX, centerY) * 0.7; // è°ƒæ•´åŠå¾„ä½¿æ˜Ÿå®¿åç§°ä¸è¢«æˆªæ–­

    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);

    // ç»˜åˆ¶èƒŒæ™¯æ¸å˜
    this.drawBackground(ctx, centerX, centerY, radius);

    // ç»˜åˆ¶å››è±¡åˆ†åŒºè¿çº¿
    this.drawQuadrantLines(ctx, centerX, centerY, radius);

    // ç»˜åˆ¶è½¨é“åœ†ç¯
    this.drawOrbit(ctx, centerX, centerY, radius);

    // ç»˜åˆ¶ 28 æ˜Ÿå®¿
    this.drawStars(ctx, centerX, centerY, radius);

    // ç»˜åˆ¶ä¸­å¿ƒæ ‡è®°
    this.drawCenterMark(ctx, centerX, centerY);
  }

  /**
   * ç»˜åˆ¶èƒŒæ™¯æ¸å˜
   */
  private drawBackground(ctx: CanvasRenderingContext2D, centerX: number, centerY: number, radius: number) {
    // å¾„å‘æ¸å˜èƒŒæ™¯
    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius * 1.2);
    gradient.addColorStop(0, '#1a0033');
    gradient.addColorStop(0.5, '#0d001a');
    gradient.addColorStop(1, '#000000');
    
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);
  }

  /**
   * ç»˜åˆ¶å››è±¡åˆ†åŒºè¿çº¿
   */
  private drawQuadrantLines(ctx: CanvasRenderingContext2D, centerX: number, centerY: number, radius: number) {
    ctx.strokeStyle = '#333333';
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 5]);

    // ä¸œæ–¹é’é¾™ (0-6): å³ä¾§
    // åŒ—æ–¹ç„æ­¦ (7-13): ä¸Šæ–¹
    // è¥¿æ–¹ç™½è™ (14-20): å·¦ä¾§
    // å—æ–¹æœ±é›€ (21-27): ä¸‹æ–¹
    
    // å‚ç›´çº¿
    ctx.beginPath();
    ctx.moveTo(centerX, centerY - radius * 1.1);
    ctx.lineTo(centerX, centerY + radius * 1.1);
    ctx.stroke();

    // æ°´å¹³çº¿
    ctx.beginPath();
    ctx.moveTo(centerX - radius * 1.1, centerY);
    ctx.lineTo(centerX + radius * 1.1, centerY);
    ctx.stroke();

    ctx.setLineDash([]);
  }

  /**
   * ç»˜åˆ¶è½¨é“åœ†ç¯
   */
  private drawOrbit(ctx: CanvasRenderingContext2D, centerX: number, centerY: number, radius: number) {
    ctx.strokeStyle = '#D4AF37';
    ctx.lineWidth = 2;
    ctx.globalAlpha = 0.3;
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.stroke();
    
    ctx.globalAlpha = 1.0;
  }

  /**
   * ç»˜åˆ¶ 28 æ˜Ÿå®¿
   */
  private drawStars(ctx: CanvasRenderingContext2D, centerX: number, centerY: number, radius: number) {
    const angleStep = (Math.PI * 2) / 28;
    const startAngle = -Math.PI / 2; // ä»é¡¶éƒ¨å¼€å§‹

    for (let i = 0; i < this.stars.length; i++) {
      const star = this.stars[i];
      const angle = startAngle + i * angleStep;
      const x = centerX + radius * Math.cos(angle);
      const y = centerY + radius * Math.sin(angle);

      // åˆ¤æ–­æ˜Ÿå®¿æ‰€å±æ˜Ÿå£
      const color = this.getStarColor(i);
      
      // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·ä¸»æ˜Ÿ
      const isUserStar = star === this.currentUserStar;
      const isSelected = star === this.selectedStar;

      // è·å–æ˜Ÿå®¿å¯¹åº”çš„ç¦½è±¡
      const animalEmoji = this.getAnimalEmoji(star);

      // ç»˜åˆ¶ç¦½è±¡å›¾æ ‡ï¼ˆä½¿ç”¨æ–‡å­—ï¼‰
      ctx.font = isUserStar ? '24px sans-serif' : (isSelected ? '20px sans-serif' : '16px sans-serif');
      ctx.fillStyle = color;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(animalEmoji, x, y);

      // ç”¨æˆ·ä¸»æ˜ŸåŠ å…‰æ™•æ•ˆæœ
      if (isUserStar) {
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI * 2);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.5;
        ctx.stroke();
        ctx.globalAlpha = 1.0;
        
        // å†åŠ ä¸€åœˆå¤–å›´å…‰æ™•
        ctx.beginPath();
        ctx.arc(x, y, 28, 0, Math.PI * 2);
        ctx.strokeStyle = '#D4AF37';
        ctx.lineWidth = 1;
        ctx.globalAlpha = 0.3;
        ctx.stroke();
        ctx.globalAlpha = 1.0;
      }

      // é€‰ä¸­æ˜Ÿå®¿åŠ è¾¹æ¡†
      if (isSelected) {
        ctx.beginPath();
        ctx.arc(x, y, 18, 0, Math.PI * 2);
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      // ç»˜åˆ¶æ˜Ÿå®¿åç§°
      ctx.font = '11px sans-serif';
      ctx.fillStyle = isUserStar ? '#D4AF37' : '#FFFFFF';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // è®¡ç®—æ–‡å­—åç§»ï¼ˆè®©æ–‡å­—åœ¨åœ†å¤–ä¾§ï¼‰
      const textRadius = radius + 25;
      const textX = centerX + textRadius * Math.cos(angle);
      const textY = centerY + textRadius * Math.sin(angle);
      
      ctx.fillText(star, textX, textY);
    }
  }

  /**
   * ç»˜åˆ¶ä¸­å¿ƒæ ‡è®°
   */
  private drawCenterMark(ctx: CanvasRenderingContext2D, centerX: number, centerY: number) {
    // ç»˜åˆ¶ä¸­å¿ƒåœ†ç‚¹
    ctx.beginPath();
    ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#D4AF37';
    ctx.fill();

    // ç»˜åˆ¶ä¸­å¿ƒæ–‡å­—
    ctx.font = '14px sans-serif';
    ctx.fillStyle = '#D4AF37';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillText('å¤©æ', centerX, centerY + 10);
  }

  /**
   * è·å–æ˜Ÿå®¿é¢œè‰²ï¼ˆæ ¹æ®æ‰€å±æ˜Ÿå£ï¼‰
   */
  private getStarColor(index: number): string {
    if (index < 7) return this.colors.east;      // ä¸œæ–¹é’é¾™
    if (index < 14) return this.colors.north;    // åŒ—æ–¹ç„æ­¦
    if (index < 21) return this.colors.west;     // è¥¿æ–¹ç™½è™
    return this.colors.south;                     // å—æ–¹æœ±é›€
  }

  /**
   * è·å–ç¦½è±¡ Emoji å›¾æ ‡
   * æ ¹æ®æ˜Ÿå®¿åç§°è¿”å›å¯¹åº”çš„ç¦½ç±» emoji
   */
  private getAnimalEmoji(starName: string): string {
    // 28æ˜Ÿå®¿å¯¹åº”çš„ç¦½è±¡ emoji æ˜ å°„
    const animalMap: Record<string, string> = {
      // ä¸œæ–¹é’é¾™ä¸ƒå®¿
      'è§’': 'ğŸŠ',  // è›Ÿ
      'äº¢': 'ğŸ‰',  // é¾™
      'æ°': 'ğŸ¦',  // ç‹¢
      'æˆ¿': 'ğŸ‡',  // å…”
      'å¿ƒ': 'ğŸ¦Š',  // ç‹
      'å°¾': 'ğŸ…',  // è™
      'ç®•': 'ğŸ†',  // è±¹
      
      // åŒ—æ–¹ç„æ­¦ä¸ƒå®¿
      'æ–—': 'ğŸ¦„',  // éº’(ç‹´)
      'ç‰›': 'ğŸ‚',  // ç‰›
      'å¥³': 'ğŸ¦‡',  // è 
      'è™š': 'ğŸ',  // é¼ 
      'å±': 'ğŸ¦',  // ç‡•
      'å®¤': 'ğŸ—',  // çŒª
      'å£': 'ğŸ¦”',  // è±ªçŒª(çŒª)
      
      // è¥¿æ–¹ç™½è™ä¸ƒå®¿
      'å¤”': 'ğŸº',  // ç‹¼
      'å¨„': 'ğŸ•',  // ç‹—
      'èƒƒ': 'ğŸ¦‰',  // é¸¡
      'æ˜´': 'ğŸ“',  // é¸¡
      'æ¯•': 'ğŸ¦',  // ä¹Œé¸¦(é¸¡)
      'è§œ': 'ğŸµ',  // çŒ´
      'å‚': 'ğŸ¦',  // çŒ¿
      
      // å—æ–¹æœ±é›€ä¸ƒå®¿
      'äº•': 'ğŸ¦Œ',  // çŠ´
      'é¬¼': 'ğŸ‘',  // ç¾Š
      'æŸ³': 'ğŸ¦Œ',  // é¹¿
      'æ˜Ÿ': 'ğŸ´',  // é©¬
      'å¼ ': 'ğŸ¦Œ',  // é¹¿
      'ç¿¼': 'ğŸ',  // è›‡
      'è½¸': 'ğŸ›'   // èš“
    };
    
    return animalMap[starName] || 'â­';  // é»˜è®¤è¿”å›æ˜Ÿæ˜Ÿ
  }

  /**
   * å¤„ç† Canvas ç‚¹å‡»äº‹ä»¶
   */
  private async handleCanvasTouch(touchX: number, touchY: number) {
    const centerX = this.canvasWidth / 2;
    const centerY = this.canvasHeight / 2;
    const radius = Math.min(centerX, centerY) * 0.75;
    const angleStep = (Math.PI * 2) / 28;
    const startAngle = -Math.PI / 2;

    // æ£€æµ‹ç‚¹å‡»çš„æ˜Ÿå®¿
    for (let i = 0; i < this.stars.length; i++) {
      const angle = startAngle + i * angleStep;
      const x = centerX + radius * Math.cos(angle);
      const y = centerY + radius * Math.sin(angle);

      const distance = Math.sqrt(Math.pow(touchX - x, 2) + Math.pow(touchY - y, 2));
      
      if (distance < 15) {
        this.selectedStar = this.stars[i];
        this.selectedStarDetail = await this.logicEngine.getStarDetail(this.stars[i]);
        this.drawStarMap(); // é‡ç»˜ä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
        break;
      }
    }
  }
}
